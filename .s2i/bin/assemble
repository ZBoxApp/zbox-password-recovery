#!/bin/bash

[ -d "/usr/src/app" ] && exit 0

set -e

echo "Aqui recuperamos los Artifacts"
echo "ls /tmp"
ls /tmp/
if [ "$(ls /tmp/artifacts 2>/dev/null)" ]; then
    echo "Copiando node modules"
    mv /tmp/artifacts/* ./
    echo "Listando archivos copiados"
    ls ./
fi

echo "---> Installing application source"
cp -Rf /tmp/src/. ./

echo "---> Building your Node application from source"
npm install -d

echo "---> El Path de comandos es:"
echo $PATH

echo "---> El contenido de los modules es:"
ls -l /opt/app-root/src/node_modules/

mkdir -p /opt/app-root/src/node_modules/.bin/

echo "---> Los ejecutables de node en /opt/app-root/src/node_modules/.bin/ son:"
ls -l /opt/app-root/src/node_modules/.bin/

ln -s /opt/app-root/src/node_modules/webpack/bin/webpack.js /opt/app-root/src/node_modules/.bin/webpack
ln -s /opt/app-root/src/node_modules/gulp/bin/gulp.js /opt/app-root/src/node_modules/.bin/gulp

echo "---> Enlaces:"
ls -l /opt/app-root/src/node_modules/.bin/

npm run build-webpack
npm run build-assets

# Fix source directory permissions
fix-permissions ./
